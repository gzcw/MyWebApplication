@{
    //-------------------------------------------------------------------
    //【Authorization】Select
    //-------------------------------------------------------------------

    Layout = "~/Views/Shared/_GridLayout.cshtml";
}

@section PageCommandBefore{
    <div id="searchPanel"></div>
}
@section Buttons{
   <a class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="save();">确定</a>
   <a class="easyui-linkbutton" data-options="iconCls:'icon-reload',plain:true" onclick="close();">刷新</a>
}
<table id="mytreegrid"></table>

<script>
    var me = this;
    var mygrid = $('#mytreegrid');
    var mygridConfig = {};
    var urlParams = commonhelper.getUrlParams();

    $(document).ready(function () {
        initGrid();
        initSearchPanel();
    });

    function initGrid() {
	    var filters = me.filters || [];

		var opts={
            url:window.applicationPath +'/Authorize/Authorization/GetTreePaged',
            border: true,
            fit:true,
            pagination: true,
            rownumbers: true,
		    singleSelect:true,
			striped:true,
			idField:'ID',
			treeField:'Name',
            cascadeCheck:false,
			columns:[[
			                { field: 'Name', title: "资源名称",width:200 },
			                { field: 'RTypeName', title: "资源类型",width:100 },
			                { field: 'Url', title: "路径",width:200 },
			                { field: 'UrlSign', title: "路径参数",width:100 },
			                { field: 'Method', title: "方法",width:100 },
			                { field: 'Icon', title: "图标",width:100 },
			                { field: 'SortNumber', title: "排序号",width:100 }
						]],
            queryParams: {
                RoleID: urlParams.id,
                filters: JSON.stringify(me.filters),
				orders:'SORTNUMBER ASC'
            },
            checkbox: true,
            loadFilter: function (data, parentId) {
                if (parentId != undefined && (data.length == 0 || !Array.isArray(data))) {
                    mygrid.treegrid('update', { id: parentId, row: { state: 'open' } });
                    return data;
                }
                $.each(data.rows || data, function (index, item) {
                    item.state = item.ISLEAF == 1 || item.isleaf == 1 ? 'open' : 'closed';
                    if (window.checked_ids && window.checked_ids.indexOf(item.ID) >= 0) {
                        item.checked = "checked";
                    }
                });
                return data;
            }
	    };

		mygrid.treegrid(opts);
        mygrid.queryParams = {
            RoleID: urlParams.id,
            filters: JSON.stringify(filters),
			orders:'SORTNUMBER ASC'
        }
    }

    function initSearchPanel() {
        $("#searchPanel").searchpanel({
            items: [
					    {text:'资源名称',value:'Name'}
		     			],
            parentGrid: mygrid
        });
    }

    function save() {
	   var rows = mygrid.treegrid('getCheckedNodes');
        if (rows.lenght == 0) {
            $.messager.alert('提示', '至少选中1条记录！');
            return;
        }
        var ids = $.map(rows, function (row) {
            return row.ID;
        });

        var url = window.applicationPath + '/Authorize/Role/SaveRelation_RoleAuthorization';
        $.ajax({
            url: url,
            data: { RoleID: urlParams.id, AuthorizationIDS: JSON.stringify(ids) },
            type: 'post',
            success: function (result) {
                $.messager.alert('提示', result.msg || '保存成功！');
                if (me.parentGrid) {
                    me.parentGrid.datagrid('reload');
                }
            }
        });
    }
   
    function refresh() {
        mygrid.datagrid('clearSelections');
            if (mygrid.queryParams) {
                mygrid.datagrid('load', mygrid.queryParams);
            }
            else {
                mygrid.datagrid('reload');
            }
    }
  
</script>
