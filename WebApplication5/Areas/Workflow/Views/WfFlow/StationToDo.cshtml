@{
    Layout = "../Shared/_Layout.cshtml";
    ViewBag.searchHeight = 105;
}
@section HardCodePageButtons{
    <div id="searchPanel"></div>
    <div class="toolbar panel-header">
        @if (ViewBag.UserName.IndexOf("zhg") == -1)
        {
            @*<a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-edit',plain:true" onclick="SignIn()">签收</a>*@
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-edit',plain:true" onclick="SignIn_Approve()">签收并办理</a>
            @*<a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-redo',plain:true" onclick="PaiJian()">指派</a>*@
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'arrow-turn-left'" plain="true" onclick="OnSendBack()">退回</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-clear',plain:true" onclick="OnReturn()">作废</a>
            <a href="#" id="CC" class="easyui-linkbutton" data-options="iconCls: 'icon-redo',plain:true" onclick="CC()">抄送</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-records',plain:true" onclick="ShiftRecord()">转发记录</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-process',plain:true" onclick="FlowChart()">进度情况</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-read',plain:true" onclick="View()">查看</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-user',plain:true" onclick="ShouQuan()">授权代理人</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-user',plain:true" onclick="QuXiaoShouQuan()">取消授权代理人</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-reload',plain:true" onclick="Refresh()">刷新</a>
        }
        else
        {
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'arrow-turn-left'" plain="true" onclick="OnSendBack()">退回</a>
            <a href="#" id="btn-shift" class="easyui-linkbutton" data-options="iconCls: 'icon-redo',plain:true" onclick="Shift()">发送(到经办)</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'arrow-right'" plain="true" onclick="Send()">发送(到领导)</a>
            <a href="#" id="CC" class="easyui-linkbutton" data-options="iconCls: 'icon-redo',plain:true" onclick="CC()">抄送</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-process',plain:true" onclick="FlowChart()">进度情况</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-read',plain:true" onclick="View()">查看</a>
            <a href="#" class="easyui-linkbutton" data-options="iconCls: 'icon-reload',plain:true" onclick="Refresh()">刷新</a>
        }
    </div>
}
<script src="~/Areas/Workflow/Scripts/WorkflowHelper.js"></script>
<script src="~/Areas/Workflow/Application/BWA/Grid.js"></script>
<table id="stationToDo"></table>
<style type="text/css">
    .window > .panel-body {
        padding: 2px 2px;
    }
</style>
<script>

    var me = this;
    var mygrid = $('#stationToDo');

    $(document).ready(function () {
        initGrid();
        initSearchBtn();
    });

    function initGrid() {
        var filters = me.filters || [];
        var isOutdate = pageCommonJS.getUrlParam('isOutdate');
        if (isOutdate) {
            filters.push({
                property: 'ISOUTDATE',
                value: 1,
                relation: '=',
                dataType: 'int'
            });
        }
        mygridConfig = $.extend(new BWA_GridConfig(mygrid, { isDBX: true }), {
            border: false,
            url: '@Url.Action("GetMyPagedOfStationToDo", "BWA")',
            singleSelect: true,
            queryParams: {
                filterStr: JSON.stringify(filters), orders: "ADT DESC"
            },
            onDblClickRow: function (index, row) {
                //合同部最后一步需要处理
                if ('@ViewBag.UserName.IndexOf("zhg")' == "-1" || ('@ViewBag.UserName' == "htbzhg" && row.FK_NODE == 20745)) {
                    approve(row);
                }
                else {
                    var workflowParams = {
                        workflowNo: row.BWLXID,
                        workID: row.WORKID,
                        nodeID: row.FK_NODE,
                        nodeName: row.NODENAME,
                        wfState: row.WFSTATE,
                        bwaID: row.ID,
                        privilege: "read",
                        permission: 0,
                        SLBH: row.SLBH,
                        ISLASTNODE: row.ISLASTNODE || 0
                    };
                    var url = RootDirectory + "/Workflow/WfFlow/WfPanel?" + $.param(workflowParams);

                    pageCommonJS.openWindowAsRedirect(url); // 在用户点双击节点的时候查看
                }
            },
            onClickRow: function (rowIndex, rowData) {
                if (rowData.NODENAME == "经办部门综合岗") {
                    $('#btn-shift').linkbutton('disable');
                }
                else {
                    $('#btn-shift').linkbutton('enable');
                }
            },
            onSelect: function (index, row) {
                if (row.CCROLE != 1 && row.CCROW != 3) {
                    disabelButtons(['CC']);
                }
                else {
                    disabelButtons([]);
                }
            }
        });
        pageCommonJS.showDataGrid(mygrid, mygridConfig);

        mygrid.queryParams = {
            filterStr: JSON.stringify(filters), orders: "ADT DESC"
        }
    }
    //监听选项卡onSelect事件
    function onSelectTab() {
        mygrid.datagrid('reload');
    }

    //禁用按钮
    function disabelButtons(buttons) {
        if (buttons) {
            $('.toolbar').find('.easyui-linkbutton').each(function (index, item) {
                if (buttons.indexOf($(item).attr('id')) >= 0) {
                    $(item).linkbutton('disable');
                }
                else {
                    $(item).linkbutton('enable');
                }
            });
        }
    }

    function initSearchBtn() {
        $("#searchPanel").searchpanel({
            border: false,
            items: [{
                text: '业务编号',
                value: 'SLBH'
            }, {
                text: '业务名称',
                value: 'BWLXID',
                easyType: 'mycombotree',
                easyConfig: {
                    valueField: 'ID',
                    textField: 'BWLXMC',
                    url: '@Url.Action("GetTreeData", "BWLX")',
                    parentId: 'YWFZID',
                    state: 'closed'
                }
            }, {
                text: '节点名称',
                value: 'NODENAME'
            }, {
                text: '呈批内容',
                value: 'ZL'
            }, {
                text: '发起用户',
                value: 'SJR'
            }],
            parentGrid: mygrid
        });
    }

    //转发
    function Shift() {
        pageCommonJS.MultiSelectGrid(mygrid, function (ids, rows) {
            pageCommonJS.openDialog({
                title: '选择发送人',
                height: 300,
                items: [{
                    url: '@Url.Action("GetUserOfCurrentOrgnization", "FLOW")',
                    textField: 'NAME',
                    valueField: 'NO',
                    singleSelect: true
                }],
                callback: function (value) {
                    $.messager.progress();
                    $.ajax({
                        url: '@Url.Action("Node_Shift", "WfFlow")',
                        data: { flowDatas: JSON.stringify(rows), toEmp: value },
                        type: 'post',
                        success: function (result) {
                            $.messager.progress('close');
                            mygrid.datagrid('reload');
                            if (result.success) {
                                $.messager.alert('提示', '发送成功！');
                            }
                            else {
                                $.messager.alert('提示', result.msg);
                            }
                        }
                    });
                }
            });
        });
    }


    //直接发送
    function Send() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, record) {
            var url = '@Url.Action("WorkOpt_GetToNodes", "Node")' + '?workflowNo=' + record.FK_FLOW + '&nodeFrom=' + record.FK_NODE + '&workID=' + record.WORKID + '&FID=' + record.FID + '&singleSelect=1';
            pageCommonJS.openDialog({
                title: '选择发送节点',
                items: [{
                    url: url,
                    textField: 'NAME',
                    valueField: 'NO',
                    parentField: 'FK_NODE',
                    singleSelect: true,
                    onlyLeafCheck: true
                }],
                callback: function (value, rows) {
                    $.messager.progress();
                    var url = '@Url.Action("Node_SendWork", "WfFlow")';

                    @*if (rows[0].RUNMODEL == -1) {
                        url = '@Url.Action("Node_SkipSendWork", "WfFlow")';
                    }*@
                    $.ajax({
                        url: url,
                        data: {
                            flowNo: record.FK_FLOW,
                            workID: record.WORKID,
                            currentNodeId: record.FK_NODE,
                            toNodeId: rows[0].FK_NODE,
                            SLBH: record.SLBH,
                            bwaId: record.ID,
                            paramPairs: "",
                            nextWorker: value
                        },
                        success: function (result) {
                            $.messager.progress('close');
                            var message = result.success ? "操作成功" : "操作失败";
                            $.messager.alert("提示", result.message || message);
                            if (result.success) {
                                mygrid.datagrid('reload');
                            }
                        }
                    });
                }
            });
        })
    }

    //签收
    function SignIn() {
        var records = mygrid.datagrid("getSelections");
        if (!records || records.length == 0) {
            $.messager.alert('提示', '请选择记录！');
            return;
        }
        var msg = [];
        $.messager.progress();
        $.each(records, function (index, record) {
            $.ajax({
                url: '@Url.Action("Node_SetWorkRead", "WfFlow")',
                data: { nodeID: record.FK_NODE, workID: record.WORKID, FID: record.FID, flowNo: record.FK_FLOW, author: record.AUTHOR, FK_EMP: record.FK_EMP },
                async: false,
                success: function (result) {
                    if (result.success === false) {
                        msg.push("【" + record.SLBH + "】" + result.message);
                    }
                }
            })
        })
        mygrid.datagrid("clearSelections");
        if (msg.length > 0) {
            $.messager.progress('close');
            $.messager.alert('提示', msg.join(','));
        }
        else {
            $.messager.progress('close');
            $.messager.showMessage("操作成功！");
            mygrid.datagrid('reload');
        }
    }

    //签收并办理
    function SignIn_Approve() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, row) {
            approve(row);
        });
    }

    //办理
    function approve(row) {
        $.ajax({
            url: '@Url.Action("Node_SetWorkRead", "WfFlow")',
            data: { nodeID: row.FK_NODE, workID: row.WORKID, flowNo: row.FK_FLOW, author: row.AUTHOR, FK_EMP: row.FK_EMP },
            async: false,
            success: function (result) {
                if (result.success === false) {
                    $.messager.alert("提示", result.message || "操作失败，请刷新页面重试！");
                }
                else {
                    mygrid.datagrid('reload');
                    var workflowParams = {
                        workflowNo: row.FK_FLOW,
                        workID: row.WORKID,
                        nodeID: row.FK_NODE,
                        nodeName: row.NODENAME,
                        wfState: 2,
                        bwaID: row.ID,
                        FID: row.FID,
                        SLBH: row.SLBH,
                        BWLXID: row.BWLXID,
                        BWLXMC: row.BWLXMC,
                        YWFZ: row.YWFZ,
                        LISTTYPE: row.LISTTYPE,
                        ISLASTNODE: row.ISLASTNODE || 0
                    };
                    var url = RootDirectory + "/Workflow/WfFlow/WfPanel?" + $.param(workflowParams);

                    pageCommonJS.openWindowAsRedirect(url);
                }
            }
        })
    }

    //派件
    function PaiJian() {
        pageCommonJS.MultiSelectGrid(mygrid, function (ids, rows) {

            var flag = true;

            var nodeIDs = "";
            $.each(rows, function (index, row) {
                nodeIDs += row.FK_NODE + ",";
                if (row.NODENAME != '派工') {
                    flag = false;
                    return false;
                }
            })

            if (flag == false) {
                $.messager.alert('提示', '只有【派工】环节才能执行指派！');
                return;
            }

            pageCommonJS.openDialog({
                title: '选择经办人',
                height: 300,
                items: [{
                    url: '@Url.Action("GetUserOfNextNodeIDs", "FLOW")?nodeIDs=' + nodeIDs,
                    textField: 'NAME',
                    valueField: 'NO',
                    singleSelect: true
                }],
                callback: function (value) {
                    $.messager.progress();
                    $.ajax({
                        url: '@Url.Action("PaiJian", "WfFlow")',
                        data: { flowDatas: JSON.stringify(rows), toEmp: value },
                        type: 'post',
                        success: function (result) {
                            $.messager.progress('close');
                            mygrid.datagrid('reload');
                            if (result.success) {
                                $.messager.alert('提示', '派件成功！');
                            }
                            else {
                                $.messager.alert('提示', result.msg);
                            }
                        }
                    });
                }
            });
        });
    }

    //转发记录
    function ShiftRecord() {
        pageCommonJS.openWindowInWorkArea('@Url.Action("Shift","WfFlow")', {
            title: '转发记录',
            parentGrid: mygrid
        });
    }

    //进度情况
    function FlowChart() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, record) {
            WorkflowHelper.ShowWorkflowChart(record.ID);
        })
    }

    //退件
    function OnReturn() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, row) {
            TuiJian(row);
        });
    }
    //执行退件
    function TuiJian(row) {
        pageCommonJS.openWindowInWorkArea('@Url.Action("Form","TJXX")', {
            title: '退件信息',
            defaultValues: {
                BWAID: row.ID,
                SLBH: row.SLBH,
                YWLX: row.BWLXMC,
                YWFZ: row.YWFZ
            },
            parentGrid: mygrid,
            flowParam: { flowNo: row.FK_FLOW, nodeID: row.FK_NODE, workID: row.WORKID, FID: row.FID, currentNodeID: row.FK_NODE }
        });
    }


    //查看
    function View() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, row) {
            var workflowParams = {
                workflowNo: row.BWLXID,
                workID: row.WORKID,
                nodeID: row.FK_NODE,
                nodeName: row.NODENAME,
                wfState: row.WFSTATE,
                bwaID: row.ID,
                privilege: "read",
                permission: 0,
                SLBH: row.SLBH
            };
            var url = RootDirectory + "/Workflow/WfFlow/WfPanel?" + $.param(workflowParams);

            pageCommonJS.openWindowAsRedirect(url);
        })
    }

    //刷新
    function Refresh() {
        if (mygrid.queryParams) {
            mygrid.datagrid('load', mygrid.queryParams);
        }
        else {
            mygrid.datagrid('reload');
        }
    }

    //查询
    function Search() {

    }

    //授权
    function ShouQuan() {
        $.ajax({
            url: '/LandSystem/Workflow/WfFlow/GetAuthor',
            success: function (result) {
                if (result.success) {
                    pageCommonJS.openDialog({
                        title: '授权代理人',
                        height: 300,
                        forceSelection: false,
                        items: [{
                            url: '@Url.Action("GetUserOfCurrentOrgnization", "FLOW")',
                            textField: 'NAME',
                            valueField: 'NO',
                            singleSelect: true,
                            value: result.data
                        }],
                        callback: function (value) {
                            $.post('/LandSystem/Workflow/WfFlow/SaveAuthor', { author: value }, function (result) {
                                $.messager.alert('提示', result.msg || "保存成功！");
                            });
                        }
                    });
                }
            }
        });
    }

    function QuXiaoShouQuan() {
        $.messager.confirm("提示", "您确定取消授权代理人吗?", function (v) {
            if (!v) {
                return;
            }
            $.post('/LandSystem/Workflow/WfFlow/SaveAuthor', { author: '' }, function (result) {
                $.messager.alert('提示', result.msg || "取消授权代理人成功！");
            });
        });
    }

    //退回
    function OnSendBack() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, record) {
            $.messager.progress();
            $.ajax({
                url: RootDirectory + '/Workflow/WfFlow/DB_GenerWillReturnNodes',
                data: { fk_node: record.FK_NODE, workId: record.WORKID, fid: record.FID },
                success: function (result) {
                    $.messager.progress('close');
                    if (!result || result.length == 0) {
                        $.messager.alert('提示', '当前节点不能退回！');
                        return;
                    }

                    pageCommonJS.openDialog({
                        title: '选择需要退回的环节',
                        items: [{
                            data: result,
                            textField: 'Name',
                            valueField: 'NodeID',
                            singleSelect: true
                        }],
                        callback: function (val) {
                            Back(record, val);
                        }
                    });
                }
            });
        });
    }
    //执行退回
    function Back(record, val) {
        $.ajax({
            url: RootDirectory + '/Workflow/WfFlow/Node_ReturnWork',
            data: { fk_flow: record.FK_FLOW, workID: record.WORKID, fid: record.FID, currentNodeID: record.FK_NODE, returnToNodeID: val },
            success: function (result) {
                if (result.success) {
                    mygrid.datagrid("reload");
                }
                else {
                    $.messager.alert('提示', result.msg || '操作失败！');
                }
            }
        });
    }

    //抄送
    function CC() {
        pageCommonJS.SingleSelectGrid(mygrid, function (id, record) {
            if (record.CCROLE != 1 && record.CCROLE != 3) {
                $.messager.alert('提示', '该流程节点不能抄送！');
                return;
            }
            pageCommonJS.openDialog({
                title: '选择抄送人',
                height: 300,
                items: [{
                    url: '/LandSystem/Workflow/CommonBussiness/GetAllUser?filterCurrentDepartment=' + (record.HISDEPTSTRS == 1 ? "true" : "false"),
                    textField: 'NAME',
                    valueField: 'ID',
                    parentField: 'PARENTID',
                    onlyLeafCheck: true,
                    expand: record.HISDEPTSTRS == 1 ? true : false
                }],
                callback: function (value, row) {

                    $.messager.progress();
                    $.ajax({
                        url: '@Url.Action("CC", "WfFlow")',
                        data: {
                            flowNo: record.FK_FLOW,
                            workID: record.WORKID,
                            currentNodeId: record.FK_NODE,
                            SLBH: record.SLBH,
                            cclist: value
                        },
                        type: 'post',
                        success: function (result) {
                            $.messager.progress('close');
                            $.messager.alert('提示', result.msg);
                        }
                    });
                }
            });
        });
    }
</script>
